name: "Auto-update SQLite sources"

on:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  upgrade:
    name: "Upgrade SQLite sources"
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1
          ref: sqlite

      - name: "Get latest version"
        id: version
        uses: .github/actions/sqliteversion

      - name: "Get URL"
        id: url
        env:
          DATE: ${{ steps.version.outputs.date }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          YEAR=$(echo $DATE | cut -d '-' -f 1)
          URL="https://sqlite.org/$YEAR/sqlite-amalgamation-${VERSION}.zip"
          echo "::set-output name=url::$URL"

      - name: "Download and extract SQLite amalgamation sources"
        env:
          URL: ${{ steps.url.outputs.url }}
        run: |
          curl -sO $URL

          ARCHIVE=$(basename $URL)
          unzip -o $ARCHIVE

          DIR=$(basename $ARCHIVE .zip)
          for _F in *.[ch]; do
            cp -vf $DIR/$_F $_F
          done

          rm -rf $DIR

      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: "Add SQLite $VERSION sources"
          title: "Add SQLite $VERSION sources"
          branch: sqlite-$VERSION
